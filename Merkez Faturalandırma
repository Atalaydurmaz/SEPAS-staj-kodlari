------drop table #tmp

create table #tmp 
(INTOPBEL VARCHAR (17) collate Turkish_CI_AI)

Insert into #tmp
(INTOPBEL)
select tt.INTOPBEL from SepasTM1DB..ZBI_T_FATURA_RAP tt where tt.INTOPBEL<>''



------

select
--t.MANDT as [Üst birim],
t.ANLAGE as [Tesisat],
t.ZZSAYACID as [Sayaç ID],
t.POINTOFDELIVERY as [Sayım nok.tnm.],
--t.VREFER as [Eski Sist.Söz.No],
t.VKONT as [Sözleşme hesabı],
t.ABWVK as [Toplu ftr.hsp.],
--t.VERTRAG as [Sözleşme],
t.PARTNER as [Muhatap],
t.NAME as [Muhatabın Tanımı],
t.ZZSOZLESMETUR as [Sözleşme türü],
t.ZZSOZLESMETUR_TEXT as [Sözleşme türü tanımı],
t.VERGI_NO as [Vergi No],
t.OPBEL as [Yzdm.blg.],
t.ZZTOP_FATNO as [Toplu Fatura No],
t.REV_ERNAM as [Fatura TK Alan Kulla],
t.GIB_SEND as [GİB'e Gönderildi],
t.MAIL_SEND as [Mail Gönderildi],
t.EFATURA as [E-Fatura],
t.ZZMATBU_NO as [Matbu No],
--t.ILK_OKUMA_TARIHI as [İlk Okuma Tarihi],
--t.SON_OKUMA_TARIHI as [Son Okuma Tarihi],
--t.ABRVORG as [Tahakkuk işlemi],
t.ABRVORG_TEXT as [Tahakkuk işlemi Tanımı],
--t.SOZ_GUCU as [Sözleşme Gücü],
--t.KUR_GUCU as [Kurulu Güç],
t.CARPAN as [Çarpan],
--t.CEP_NUMBER as [Telefon],
--t.TCNO as [TC Kimlik No],
--t.VERGI_DAIRESI as [Vergi Dairesi],
--t.VERART as [Mhsplşt.türü],
t.ZZTERIM_TEXT as [Terim Tanımı],
t.OSB_GROUP as [Yerinde thk.gr.],
--t.GERAET as [Cihaz],
--t.EGERR_INFO as [Sayaç Marka/Tip],
t.BUDAT as [Kayıt tarihi],
t.DISTRIBUTOR as [Dağıtım şirketi],
t.BILLING_PERIOD as [Dönem],
t.TARIFTYP as [Tarife tipi],
--t.ABONE_GRUBU as [Abone Grubu],
t.TARIFTYP_TEXT as [Abone Grubu Tanımı],
t.ERNAM as [Yaratan],
t.ERDAT as [Yaratma trh.],
t.DRUCKDAT as [Yazdırma tarihi],
t.FAEDN as [Net ödm.vd.trh.],
t.EINZDAT as [Abonelik tarihi],
--t.AUSZDAT as [AboniptTr],
--t.AUSZDAT as [AboneİptalTrh.],
--t.ZAHLKOND as [Ödeme koşulu],
SUM (t.TAHAKKUK_SAYISI) as [Tahakkuk Say�s�],
--SUM (t.E0_ILK) as [E0 İlk Endeks],
--SUM (t.E1_ILK) as [E1 İlk Endeks],
--SUM (t.E2_ILK) as [E2 İlk Endeks],
--SUM (t.E3_ILK) as [E3 İlk Endeks],
--SUM (t.E0_SON) as [E0 Son Endeks],
--SUM (t.E1_SON) as [E1 Son Endeks],
--SUM (t.E2_SON) as [E2 Son Endeks],
--SUM (t.E3_SON) as [E3 Son Endeks],
--SUM (t.RI_ILK) as [RI İlk Endeks],
--SUM (t.RI_SON) as [RI Son Endeks],
--SUM (t.RC_ILK) as [RC İlk Endeks],
--SUM (t.RC_SON) as [RC Son Endeks],
--SUM (t.P_OKUNAN) as [P Okunan],
SUM (t.T0) as [T0 Tüketim],
SUM (t.T1) as [T1 Tüketim],
SUM (t.T2) as [T2 Tüketim],
SUM (t.T3) as [T3 Tüketim],
isnull(Sum(t.T0_K2),0) as T0_Kad2Tük,
isnull(Sum(t.T1_K2),0) as T1_Kad2Tük,
isnull(Sum(t.T2_K2),0) as T2_Kad2Tük,
isnull(Sum(t.T3_K2),0) as T3_Kad2Tük,
sum (t.T0_EKTUK+isnull(t.T0_EKTUK_K2,0)) as T0_EkTük,
sum (t.T1_EKTUK+isnull(t.T1_EKTUK_K2,0)) as T1_EkTük,
sum (t.T2_EKTUK+isnull(t.T2_EKTUK_K2,0)) as T2_EkTük,
sum (t.T3_EKTUK+isnull(t.T3_EKTUK_K2,0)) as T3_EkTük,
sum (t.T0_TK_TUK) as 'TO_Trafo_Kaybı',
SUM (t.T1_TK_TUK) as 'T1_Trafo_Kaybı',
SUM (t.T2_TK_TUK) as 'T2_Trafo_Kaybı',
SUM (t.T3_TK_TUK) as 'T3_Trafo_Kaybı',
SUM (t.AKTIF_TL) as 'Aktif Tutar',
SUM (t.AKTIF_KWH) as 'Aktif Tüketim',
--sum (t.T0_TUTAR)as T0_Aktif_TL,
--SUM (t.T1_TUTAR) as T1_Aktif_TL,
--SUM (t.T2_TUTAR)AS T2_Aktif_TL,
--sum (t.T3_TUTAR) AS T3_Aktif_TL,
--isnull(SUM (t.T0_TUTAR_K2),0)as T0_Kad2TL,
--isnull(SUM (t.T1_TUTAR_K2),0)as T1_Kad2TL,
--isnull(SUM (t.T2_TUTAR_K2),0)as T2_Kad2TL,
--isnull(SUM (t.T3_TUTAR_K2),0)as T3_Kad2TL,
--sum (t.EKTUK_TUTARI+ isnull(t.EKTUK_TUTARI_K2,0)) as 'Ektuk_TL',
--sum (t.T0_TK_BEDELI) as 'T0_TrafoKaybı_TL',
--sum (t.T1_TK_BEDELI) as 'T1_TrafoKaybı_TL',
--sum (t.T2_TK_BEDELI) as 'T2_TrafoKaybı_TL',
--sum(t.T3_TK_BEDELI) as 'T3_TrafoKaybı_TL',
--SUM (t.RI) as [RI Tüketim],
--SUM (t.RC) as [RC Tüketim],
--SUM (t.REAKTIF_TUK) as [Reaktif Tüketim],
--SUM (t.YEKDEM_TUK) as [YEKDEM Tüketim],
--SUM (t.GUC_ASIM_TUK) as [Güç Aşım Tüketim],
--SUM (t.GUC_TUK) as [Güç Tüketim],
--SUM (t.P) as [P Tüketim],
--SUM (t.T0_FIYAT) as [T0 Fiyatı],
--SUM (t.T1_FIYAT) as [T1 Fiyatı],
--SUM (t.T2_FIYAT) as [T2 Fiyatı],
--SUM (t.T3_FIYAT) as [T3 Fiyatı],
--SUM (t.DAG_FIYATI) as [Dağıtım Fiyatı],
--SUM (t.REAKTIF_FIYATI) as [Reaktif Fiyatı],
--SUM (t.GUC_ASIM_FIYATI) as [Güç Aşım Fiyatı],
--SUM (t.GUC_FIYATI) as [Güç Fiyatı],
--SUM (t.YEKDEM_FIYAT) as [YEKDEM Fiyat�],
--SUM (t.DAG_BEDELI) as [Dağıtım Tutarı],
--SUM (t.RI_BEDELI) as [RI Bedeli],
--SUM (t.RC_BEDELI) as [RC Bedeli],
--SUM (t.REAKTIF_BEDELI) as [Reaktif Tutarı],
--SUM (t.ENERJI_FONU_TUTARI) as [EF Tutarı],
--SUM (t.TRT_TUTARI) as [TRT Tutarı],
--SUM (t.BTV_TUTARI) as [BTV Tutarı],
--SUM (t.GUC_ASIM_BEDELI) as [Güç Aşım Tutarı],
--SUM (t.GUC_BEDELI) as [Güç Tutarı],
--SUM (t.YEKDEM_BEDELI) as [YEKDEM Tutarı],
--SUM (t.T0_EKTUK) as [T0 Ek Tüketim],
--SUM (t.T1_EKTUK) as [T1 Ek Tüketim],
--SUM (t.T2_EKTUK) as [T2 Ek Tüketim],
--SUM (t.T3_EKTUK) as [T3 Ek Tüketim],
--SUM (t.RI_EKTUK) as [RI Ek Tüketim],
--SUM (t.RC_EKTUK) as [RC Ek Tüketim],
--t.GDDK_NEDENI as [GDDK/Ek Tüketim Nede],
--SUM (t.GUC_ASIM_EKTUK) as [Güç Aşım Ek Tüketim],
--SUM (t.GUC_EKTUK) as [G�� Ek T�ketim],
--SUM (t.YEKDEM_EKTUK) as [YEKDEM Ek T�ketim],
--SUM (t.EKTUK_TUTARI) as [Ek T�ketim Tutar�],
--SUM (t.GUVENCE_BEDELI) as [G�vence Bedeli],
----t.ENERJI_FONU_ORANI as [EF Oran�],
----t.TRT_ORANI as [TRT Oran�],
----t.BTV_ORANI as [BTV Oran�],
----SUM (t.KULL_BEDELI) as [Kullan�m Bedeli],
----SUM (t.FON_BEDELI) as [Fon Bedelleri],
----t.T0_INDOR as [T0 �ndirim Oran�],
----t.T1_INDOR as [T1 �ndirim Oran�],
----t.T2_INDOR as [T2 �ndirim Oran�],
----t.T3_INDOR as [T3 �ndirim Oran�],
----t.T0_TK_FIYAT as [T0 TK Fiyat�],
----t.T1_TK_FIYAT as [T1 TK Fiyat�],
----t.T2_TK_FIYAT as [T2 TK Fiyat�],
----t.T3_TK_FIYAT as [T3 TK Fiyat�],
--SUM (t.TUIK_AKTIF_ENERJI) as [T��K Aktif Enerji Bedeli],
--SUM (t.TUIK_DAGITIM_FON) as [T��K Da��t�m Fon Bedeli],
--SUM (t.AK_BEDELI) as [A�ma-Kesme Bedeli],
--SUM (t.SOKME_TAKMA_BEDELI) as [S�kme Takma Bedeli],
--SUM (t.SK_BEDELI) as [Saya� Kontrol Bedeli],
--SUM (t.KDV) as [KDV],
--SUM (t.MUSTERI_ALACAGI) as [M��teri Alaca��],
----t.YEKDEM_GNL_FIYAT as [YEKDEM Genel Fiyat],
----SUM (t.YEKDEM_CAP) as [YEKDEM CAP],
--SUM (t.TENZIL_ILAVE) as [Tenzil/�lave],
--SUM (t.TENZIL_ILAVE_KDV) as [Tenzil/�lave KDV],
--t.GUN_ORT_TUK as [G�nl�k Ortalama T�ketim],
--t.YILLIK_TUK as [Y�ll�k T�ketim],
--t.ONCEKI_YIL_TUK as [�nceki Y�l T�ketim],
--SUM (t.GEC_BEDELI) as [Gecikme Bedeli],
--SUM (t.GEC_BEDELI_KDV) as [Gecikme Bedeli KDV],
--t.KAR as [K�r],
--t.KAR_ULUSAL_TOPLAM as [K�r Ulusal Toplam],
--t.KAR_SEPAS_TOPLAM as [K�r SEPA� Toplam],
--t.ROUNDO as [Eski Yuvarlama],
--t.ROUND as [Yeni Yuvarlama],
--SUM (t.KDV_MATRAHI) as [KDV Matrah�],
SUM (t.FATURA_TUTARI) as [Fatura Tutar�],
--SUM (t.TOTAL_AMNT) as [Toplam �denecek Tutar],
--t.RI_T0_ORANI as [End./Aktif T�k. Oran],
--t.RC_T0_ORANI as [Kap./Aktif T�k. Oran],
--t.STOKZ as [Belge ters kyt.],
--t.INTOPBEL as [Trs.kyt.blg.no.],
--t.REASON as [Ters kyt.nedeni],
--t.REASON_TEXT as [Ters Kay�t Nedeni Ta],
--t.BIRIM as [Hataya Sebep Olan Bi],
--t.BIRIM_TEXT as [Birim Tan�m�],
--t.TESPIT as [Hata Tespiti],
--t.TESPIT_TEXT as [Tespit Tan�m�],
--t.TEXT as [Ters Kay�t A��klama],
--t.BELGENO as [�ade Belge No],
--t.REV_ERDAT as [Fatura TK Tarihi],
--t.REV_ERZET as [Fatura TK Saati],
--t.ZZFATURAILETIM as [Fatura iletim Yolu],
--t.ZZFATURAILETIM_TEXT as [Fatura �letim Yolu T],
--t.TESIS_ADRESI as [Tesis Adresi],
--t.ADRES as [Adres],
--t.ILCE as [Yerle�im yeri],
--t.IL as [Tan�m],
--t.ICMAL_DONEMI,
--t.YEKDEM_FYT_FARKI,
--t.FIYAT_FARKI,
--t.T0_ETBEDELI,
--t.T1_ETBEDELI,
--t.T2_ETBEDELI,
--t.T3_ETBEDELI,
--t.ACIKLAMA,
case when SUBSTRING(t.TARIFTYP,7,2)='CZ' then   (t1+T2+T3+t.t1_k2+t.T2_K2+t.T3_K2+T1_TK_TUK+T2_TK_TUK+T3_TK_TUK+T1_EKTUK+T2_EKTUK+T3_EKTUK)
else t0+T0_K2+T0_TK_TUK+T0_EKTUK end ToplamT�ketim,
t.OKUMA_GUNU,
case when t.OKUMA_GUNU <25 then 'Erken'
when t.OKUMA_GUNU > 35 then 'Ge�' 
else 'Zaman�nda' end as Zaman,
t.sob
--t.TAHAKKUK_SAYISI
--t.AEZET as [De�i�iklik sa.],
--t.AEDAT as [D��k.tarihi],
--t.AENAM as [De�i�tiren],
--ys.KTOKL as AboneAltGrubu


from SepasTM1DB..ZBI_T_FATURA_RAP t
--left outer join SepasTM1DB..Z_EVER ys (nolock) on  ys.vkonto=t.vkont 
 --inner join SepasTM1DB..Z_FKKVKP ys on t.VKONT=ys.VKONT   -- Alt Abone Grubunun yer ald��� tablo
 -- inner join [SedasMuhDB].[dbo].[UnipedeKodlarinaGoreSozlesmeler] yas on t.vkont=yas.S�zle�meHesab� 
  
where --t.NAME like ('')
	--and t.BILLING_PERIOD between '2019/01' and '2019/12' 
	--and t.ERDAT between '2018-02-26' and '2018-02-26'
	--and t.ZZSAYACID in ('') --saya� ID
	--and t.YEKDEM_FYT_FARKI <>0   --Yekdem Fiyat Fark� olanlar� getir
	--and t.ABWVK in ('') --toplu s�zle�me hesab�
	--and t.ZZSOZLESMETUR between '0001' and '0004' --ulusal
	--and t.ZZSOZLESMETUR between '0005' and '0010' --st
	-- t.OPBEL in () --yazd�rma belge no
	 t.ERNAM  not in ('RFC-IMA') --belge olu�turan
	--and t.INTOPBEL = ' ' --ters kay�t al�nmayan faturalar� getirir
	--and t.ANLAGE in () --tesisat no
	--and t.VKONT in () --s�zle�me hesap no
	-- t.TARIFTYP in ()
	--and ys.KTOKL ='RDAB' and
	and t.ICMAL_DONEMI in ('2025/05') --Hangi d�nem �ekilecekse o d�nem yaz�l�r
	--and t.IL in ('D�ZCE')
	--and t.BUDAT between ('2020-04-30') and ('2020-04-30')
	--and t.TARIFTYP in ('U4TSTTTZOG')
	--and t.ZZMATBU_NO like ('E%')
	--and t.OKUMA_GUNU >35
	  and t.OPBEL  not like '7%'  --ters kay�t belgeleri gelmez
	  and t.OPBEL  not in (select INTOPBEL from #tmp)
group by 

t.ANLAGE, t.ZZSAYACID,
t.POINTOFDELIVERY,
--t.VREFER,
t.VKONT,
t.ABWVK,
--t.VERTRAG,
t.PARTNER,
t.NAME,
t.ZZSOZLESMETUR,
t.ZZSOZLESMETUR_TEXT,
t.VERGI_NO,
t.OPBEL,
t.ZZTOP_FATNO,
t.REV_ERNAM,
t.GIB_SEND,
t.MAIL_SEND,
t.EFATURA,
t.ZZMATBU_NO,
--t.ILK_OKUMA_TARIHI,
--t.SON_OKUMA_TARIHI,
--t.ABRVORG,
t.ABRVORG_TEXT,
--t.SOZ_GUCU,
--t.KUR_GUCU,
t.CARPAN,
--t.CEP_NUMBER,
--t.TCNO,
--t.VERGI_DAIRESI,
--t.VERART,
t.ZZTERIM_TEXT,
t.OSB_GROUP,
--t.GERAET,
--t.EGERR_INFO,
t.BUDAT,
t.DISTRIBUTOR,
t.BILLING_PERIOD,
t.TARIFTYP,
--t.ABONE_GRUBU],
t.TARIFTYP_TEXT,
t.ERNAM,
t.ERDAT,
t.DRUCKDAT,
t.FAEDN,
t.EINZDAT,
--t.AUSZDAT,
--t.ZAHLKOND,
--t.GDDK_NEDENI,
--t.GUN_ORT_TUK,
--t.YILLIK_TUK,
--t.ONCEKI_YIL_TUK,
--t.RI_T0_ORANI,
--t.RC_T0_ORANI,
--t.STOKZ,
--t.INTOPBEL,
--t.REASON,
--t.REASON_TEXT,
--t.BIRIM,
--t.BIRIM_TEXT,
--t.TESPIT,
--t.TESPIT_TEXT,
--t.TEXT,
--t.BELGENO,
--t.REV_ERDAT,
--t.REV_ERZET,
--t.ZZFATURAILETIM,
--t.ZZFATURAILETIM_TEXT,
--t.TESIS_ADRESI,
--t.ADRES,
--t.ILCE,
--t.IL,
--t.TOTAL_AMNT,
--t.AUSZDAT,
--t.ICMAL_DONEMI,
--t.YEKDEM_FYT_FARKI,
--t.FIYAT_FARKI,
--t.T0_ETBEDELI,
--t.T1_ETBEDELI,
--t.T2_ETBEDELI,
--t.T3_ETBEDELI,
--t.ACIKLAMA,
t.TARIFTYP,
t.T1,
t.T2,
t.T3,
T.T0_K2,
t.T1_K2,
t.T2_K2,
t.T3_K2,
t.T1_TK_TUK,
t.T2_TK_TUK,
t.T3_TK_TUK,
t.T1_EKTUK,
t.T2_EKTUK,
t.T3_EKTUK,
t.T0,
t.T0_TK_TUK,
t.T0_EKTUK,
t.OKUMA_GUNU,
t.sob
--t.TAHAKKUK_SAYISI
--t.AEZET,
--t.AEDAT,
--t.AENAM


--having sum (t.TOTAL_AMNT) > 3000
